# Fluentd configuration for Docker container logs
# This configuration collects logs from Docker containers and forwards to Cerberus

# Input: Docker container logs
<source>
  @type forward
  port 24225
  bind 0.0.0.0
  tag docker.container
</source>

# Alternative: Use Docker log driver
# Configure Docker daemon.json:
# {
#   "log-driver": "fluentd",
#   "log-opts": {
#     "fluentd-address": "localhost:24225",
#     "tag": "docker.{{.Name}}"
#   }
# }

# Filter: Parse Docker JSON logs
<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

# Filter: Add Docker metadata
<filter docker.**>
  @type record_transformer
  <record>
    docker_host "#{Socket.gethostname}"
    log_source docker
  </record>
</filter>

# Filter: Remove noisy debug logs
<filter docker.**>
  @type grep
  <exclude>
    key level
    pattern /^debug$/
  </exclude>
</filter>

# Output: Forward to Cerberus
<match docker.**>
  @type forward
  <server>
    host cerberus.example.com
    port 24224
  </server>

  # Compress for network efficiency
  compress gzip

  # Buffer settings
  <buffer>
    @type file
    path /var/log/fluentd/buffer/cerberus-docker
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 5M
    total_limit_size 500M
  </buffer>
</match>
