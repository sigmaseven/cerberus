# Fluentd configuration for web server logs (Apache and Nginx)
# This configuration parses access logs and error logs from popular web servers

# Input: Apache access logs
<source>
  @type tail
  path /var/log/apache2/access.log
  pos_file /var/log/fluentd/apache-access.pos
  tag apache.access
  <parse>
    @type apache2
  </parse>
</source>

# Input: Apache error logs
<source>
  @type tail
  path /var/log/apache2/error.log
  pos_file /var/log/fluentd/apache-error.pos
  tag apache.error
  <parse>
    @type apache_error
  </parse>
</source>

# Input: Nginx access logs
<source>
  @type tail
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx-access.pos
  tag nginx.access
  <parse>
    @type nginx
  </parse>
</source>

# Input: Nginx error logs
<source>
  @type tail
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx-error.pos
  tag nginx.error
  <parse>
    @type regexp
    expression /^(?<time>\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>[^:]+): (?<message>.*)$/
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

# Filter: Detect suspicious web activity
<filter apache.access nginx.access>
  @type grep
  <regexp>
    key path
    pattern /(admin|wp-admin|phpmyadmin|\.env|\.git)/
  </regexp>
</filter>

# Filter: Add security context for suspicious requests
<filter apache.access nginx.access>
  @type record_transformer
  <record>
    security_alert true
    alert_type web_scan
  </record>
</filter>

# Filter: Detect failed authentication attempts
<filter apache.error nginx.error>
  @type grep
  <regexp>
    key message
    pattern /(authentication|auth|login|password).*fail/i
  </regexp>
</filter>

# Filter: Add metadata to all web logs
<filter apache.** nginx.**>
  @type record_transformer
  <record>
    webserver_host "#{Socket.gethostname}"
    log_category webserver
  </record>
</filter>

# Output: High-priority security alerts to Cerberus
<match apache.access nginx.access>
  @type forward
  <server>
    host cerberus.example.com
    port 24224
  </server>

  # Prioritize security events
  <buffer>
    @type file
    path /var/log/fluentd/buffer/cerberus-web-security
    flush_mode immediate
    retry_max_times 5
  </buffer>
</match>

# Output: Error logs to Cerberus
<match apache.error nginx.error>
  @type forward
  <server>
    host cerberus.example.com
    port 24224
  </server>

  <buffer>
    @type file
    path /var/log/fluentd/buffer/cerberus-web-errors
    flush_mode interval
    flush_interval 30s
  </buffer>
</match>
