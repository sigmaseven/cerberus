# Secure Fluentd configuration for Cerberus with TLS and authentication
# This configuration uses encrypted transmission and shared key authentication

# Input: System logs
<source>
  @type tail
  path /var/log/syslog
  pos_file /var/log/fluentd/syslog.pos
  tag syslog.system
  <parse>
    @type syslog
  </parse>
</source>

# Input: Authentication logs
<source>
  @type tail
  path /var/log/auth.log
  pos_file /var/log/fluentd/auth.pos
  tag syslog.auth
  <parse>
    @type syslog
  </parse>
</source>

# Input: Application logs with JSON parsing
<source>
  @type tail
  path /var/log/app/*.log
  pos_file /var/log/fluentd/app.pos
  tag app.logs
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

# Filter: Add hostname and environment metadata
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment production
    fluentd_version "#{Fluent::VERSION}"
  </record>
</filter>

# Output: Secure forward to Cerberus with TLS
<match **>
  @type forward
  <server>
    host cerberus.example.com
    port 24224
  </server>

  # TLS Configuration
  transport tls
  tls_cert_path /etc/fluentd/certs/cerberus-ca.crt
  tls_client_cert_path /etc/fluentd/certs/client.crt
  tls_client_private_key_path /etc/fluentd/certs/client.key
  tls_verify_hostname true

  # Shared key authentication
  <security>
    self_hostname "#{Socket.gethostname}"
    shared_key your-shared-secret-key
  </security>

  # Require acknowledgments for guaranteed delivery
  require_ack_response true
  ack_response_timeout 30

  # Buffer settings for reliability
  <buffer>
    @type file
    path /var/log/fluentd/buffer/cerberus
    flush_mode interval
    flush_interval 5s
    flush_at_shutdown true
    retry_type exponential_backoff
    retry_max_times 10
    retry_wait 10s
    retry_max_interval 300s
    overflow_action block
  </buffer>
</match>
