# Fluent Bit configuration for Kubernetes cluster logging
# Designed to run as a DaemonSet and collect logs from all pods

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# Input: Kubernetes container logs
[INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    Parser            docker
    DB                /var/log/flb_kube.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# Filter: Kubernetes metadata enrichment
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Keep_Log            Off
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On
    Labels              On
    Annotations         Off

# Filter: Add cluster information
[FILTER]
    Name        modify
    Match       kube.*
    Add         cluster_name production-cluster
    Add         cluster_region us-east-1

# Filter: Exclude kube-system logs (optional)
[FILTER]
    Name        grep
    Match       kube.*
    Exclude     kubernetes.namespace_name kube-system

# Filter: Parse JSON logs
[FILTER]
    Name        parser
    Match       kube.*
    Key_Name    log
    Parser      json
    Reserve_Data On
    Preserve_Key On

# Output: Forward to Cerberus
[OUTPUT]
    Name        forward
    Match       kube.*
    Host        cerberus.example.com
    Port        24225
    Time_as_Integer On

    # Retry and buffer settings
    Retry_Limit    5
    Workers        2

# Output: Metrics (optional)
[OUTPUT]
    Name        prometheus_exporter
    Match       kube.*
    Host        0.0.0.0
    Port        2021
