# Secure Fluent Bit configuration with TLS and authentication
# For production environments requiring encrypted log transmission

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# Input: Systemd logs
[INPUT]
    Name        systemd
    Tag         syslog.system
    Systemd_Filter  _SYSTEMD_UNIT=*.service
    Read_From_Tail  On

# Input: Application logs
[INPUT]
    Name        tail
    Path        /var/log/app/*.log
    Parser      json
    Tag         app.logs
    Refresh_Interval 5
    Mem_Buf_Limit    10MB

# Input: Security logs
[INPUT]
    Name        tail
    Path        /var/log/auth.log
    Parser      syslog
    Tag         syslog.auth
    Refresh_Interval 5

# Filter: Add metadata
[FILTER]
    Name        modify
    Match       *
    Add         hostname ${HOSTNAME}
    Add         environment production
    Add         region us-east-1

# Filter: Detect suspicious authentication activity
[FILTER]
    Name        grep
    Match       syslog.auth
    Regex       message (fail|denied|invalid|unauthorized)

# Filter: Add security alert tag
[FILTER]
    Name        modify
    Match       syslog.auth
    Add         security_alert true
    Add         alert_priority high

# Output: Secure forward to Cerberus with TLS
[OUTPUT]
    Name        forward
    Match       *
    Host        cerberus.example.com
    Port        24225
    Time_as_Integer On

    # TLS Configuration
    tls         On
    tls.verify  On
    tls.ca_file /etc/fluent-bit/certs/ca.crt
    tls.crt_file /etc/fluent-bit/certs/client.crt
    tls.key_file /etc/fluent-bit/certs/client.key

    # Shared key authentication
    Shared_Key  your-shared-secret-key

    # Require acknowledgments
    Require_ack_response On

    # Retry and buffer settings
    Retry_Limit    10
    Workers        4

# Output: High-priority security alerts to separate endpoint (optional)
[OUTPUT]
    Name        forward
    Match       syslog.auth
    Host        cerberus-priority.example.com
    Port        24225
    Time_as_Integer On
    tls         On
    tls.verify  On
    tls.ca_file /etc/fluent-bit/certs/ca.crt
